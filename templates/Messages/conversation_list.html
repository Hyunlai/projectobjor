{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inbox.css' %}">
{% endblock %}

{% block content %}
<div class="inbox-container">

    <div class="inbox-header">
        <h2>Your Conversations</h2>
        <a href="{% url 'new_conversation' %}" class="btn-new-message">
            Start New Conversation
        </a>
    </div>

    <ul class="conversation-list">
        {% for conversation in conversations %}
            {% for user in conversation.participants.all %}
                {% if user != request.user %}
                    {% with other_user=user %}
                        <li class="conversation-item">
                            <a href="{% url 'conversation_detail' conversation.id %}" class="conversation-link">
                                <!-- Profile Picture -->
                                <div class="profile-circle">
                                    {% if other_user.profile.profile_picture %}
                                        <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}">
                                    {% else %}
                                        <img src="{% static 'images/default.png' %}" alt="{{ other_user.username }}">
                                    {% endif %}
                                </div>

                                <div class="conversation-info">
                                    <span class="conversation-partner">
                                        <strong>{{ other_user.username }}</strong>
                                        {% if request.user in other_user.followers.all %}
                                            <span class="badge-followed">Followed</span>
                                        {% endif %}
                                    </span>

                                    {% if conversation.last_message %}
                                        <span class="last-message">{{ conversation.last_message.text|truncatechars:50 }}</span>
                                    {% else %}
                                        <span class="last-message">
                                        {% if conversation.last_message %}
                                        {{ conversation.last_message.text|truncatechars:50 }}
                                        {% else %}
                                        <em>Continue Message</em>
                                        {% endif %}
                                        </span>
                                    {% endif %}
                                </div>

                                <span class="view-link">â†’</span>
                            </a>
                        </li>
                    {% endwith %}
                {% endif %}
            {% endfor %}
        {% empty %}
            <li class="no-conversations">
                <p>You have no ongoing conversations yet. Click "Start New Conversation" to chat!</p>
            </li>
        {% endfor %}
    </ul>

</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const conversations = document.querySelectorAll(".conversation-item");

    filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            // Remove active from all buttons
            filterButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const filter = btn.dataset.filter;

            conversations.forEach(conv => {
                conv.style.display = "flex"; // default

                if(filter === "followed" && !conv.classList.contains("followed")) {
                    conv.style.display = "none";
                }
                if(filter === "not-followed" && !conv.classList.contains("not-followed")) {
                    conv.style.display = "none";
                }
            });
        });
    });
});
</script>
{% endblock %}
