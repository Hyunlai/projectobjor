{% extends 'base.html' %}

{% block content %}
    <h1>Welcome to Chinguloop!</h1>

    {% if request.user.profile.is_banned %}
        <div style="text-align: center; margin-top: 20px; padding: 15px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px;">
            <p>Your account is currently banned. You can view posts but are unable to create, share, react, or comment.</p>
        </div>
    {% endif %}

    {% if posts %}
        <h2>Latest Posts</h2>
        {% for post in posts %}
            <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
                <a href="{% url 'profile' username=post.author.username %}" style="text-decoration: none; color: inherit;">
                    {% if post.author.profile.profile_picture %}
                        <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}'s profile picture" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                    {% else %}
                        <img src="{{ post.author.profile.profile_picture.url }}" alt="Default profile picture" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                    {% endif %}
                </a>
                <p style="display:inline;">Posted by <a href="{% url 'profile' username=post.author.username %}">{{ post.author.username }}</a> on {{ post.created_at|date:"F j, Y, P" }}</p>

                {% if post.original_post %}
                    <p>Shared from <a href="{% url 'profile' username=post.original_post.author.username %}">{{ post.original_post.author.username }}'s</a> post.</p>
                {% endif %}

                <a href="{% url 'post_detail' post_id=post.id %}" style="text-decoration: none; color: inherit;">
                    {% if post.image %}
                        <img src="{{ post.image.url }}" style="max-width: 100%; height: auto;">
                    {% endif %}
                    <p>{{ post.caption }}</p>
                </a>

                {% if not request.user.profile.is_banned %}
                    {% if request.user == post.author %}
                        <form method="post" action="{% url 'delete_post' post_id=post.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit">Delete Post</button>
                        </form>
                    {% endif %}

                    <a href="{% url 'share_post' post.id %}">Share</a>

                    <div style="margin-top: 10px;">
                        <span>{{ post.reaction_counts.like|default:0 }} Like(s)</span>
                        <span>{{ post.reaction_counts.love|default:0 }} Love(s)</span>
                        <span>{{ post.reaction_counts.haha|default:0 }} Haha(s)</span>
                        <span>{{ post.reaction_counts.wow|default:0 }} Wow(s)</span>
                        <span>{{ post.reaction_counts.cry|default:0 }} Cry(s)</span>
                        <span>{{ post.reaction_counts.angry|default:0 }} Angry(s)</span>
                        <span>{{ post.reaction_counts.dislike|default:0 }} Dislike(s)</span>
                    </div>

                    <div style="margin-top: 5px;">
                        <a href="{% url 'add_reaction' post.id 'like' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'like' %}lightblue{% endif %};">Like</a>
                        <a href="{% url 'add_reaction' post.id 'love' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'love' %}pink{% endif %};">Love</a>
                        <a href="{% url 'add_reaction' post.id 'haha' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'haha' %}yellow{% endif %};">Haha</a>
                        <a href="{% url 'add_reaction' post.id 'wow' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'wow' %}orange{% endif %};">Wow</a>
                        <a href="{% url 'add_reaction' post.id 'cry' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'cry' %}gray{% endif %};">Cry</a>
                        <a href="{% url 'add_reaction' post.id 'angry' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'angry' %}red{% endif %};">Angry</a>
                        <a href="{% url 'add_reaction' post.id 'dislike' %}" class="btn btn-primary" style="background-color: {% if post.user_reacted_type == 'dislike' %}black{% endif %};">Dislike</a>
                    </div>

                    <div style="margin-top: 15px;">
                        <h4>Latest Comment</h4>
                        <div id="latest-comment-{{ post.id }}">
                            {% with latest_comment=post.comments.all|dictsort:"created_at"|last %}
                                {% if latest_comment %}
                                    <div style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                                        <p style="display:inline;"><strong>{{ latest_comment.author.username }}</strong>: {{ latest_comment.text }}</p>
                                        {% if request.user == latest_comment.author %}
                                            <form method="post" action="{% url 'delete_comment' comment_id=latest_comment.id %}" style="display:inline; margin-left: 10px;">
                                                {% csrf_token %}
                                                <button type="submit">Delete</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <p>No comments yet.</p>
                                {% endif %}
                            {% endwith %}
                        </div>

                        <div style="margin-top: 15px;">
                            <form method="post" action="{% url 'add_comment' post_id=post.id %}" class="comment-form">
                                {% csrf_token %}
                                <input type="hidden" name="post_id" value="{{ post.id }}">
                                <textarea name="text" placeholder="Add a comment..." required></textarea>
                                <button type="submit">Comment</button>
                            </form>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>No posts to display yet.</p>
    {% endif %}

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const postId = this.querySelector('input[name="post_id"]').value;
                const commentText = this.querySelector('textarea[name="text"]').value;
                const csrfToken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;

                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: `text=${encodeURIComponent(commentText)}&parent_id=&post_id=${postId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const commentsContainer = document.getElementById(`latest-comment-${postId}`);

                        const noCommentsMsg = commentsContainer.querySelector('p');
                        if (noCommentsMsg && noCommentsMsg.textContent.trim() === 'No comments yet.') {
                            noCommentsMsg.remove();
                        }

                        const newCommentDiv = document.createElement('div');
                        newCommentDiv.style.borderTop = '1px dashed #ccc';
                        newCommentDiv.style.paddingTop = '10px';
                        newCommentDiv.style.marginTop = '10px';
                        newCommentDiv.innerHTML = `<p style="display:inline;"><strong>${data.author_username}</strong>: ${data.comment_text}</p>`;

                        commentsContainer.appendChild(newCommentDiv);

                        this.querySelector('textarea[name="text"]').value = '';
                    } else {
                        console.error('Error adding comment:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>

{% endblock %}