{% extends 'base.html' %}
{% load tz %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
{% endblock %}
{% block content %}
<div class="posts">

    <div class="post">
        <!-- Post Header -->
        <div class="post-header">
            <h3>
                <a href="{% url 'profile' username=post.author.username %}" class="post-author">
                    {{ post.author.username }}
                </a>
                {% if request.user.is_authenticated and request.user.admin.is_admin and post.author.admin.is_admin %}
                    <span class="badge-admin">ADMIN</span>
                {% endif %}
            </h3>
            <p class="post-date"><small>Posted on {{ post.created_at|localtime|date:"F j, Y, P" }}</small></p>
        </div>

        <!-- Post Media -->
        <div class="post-media-container">
            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Post image" class="post-media">
            {% elif post.video %}
                <video controls class="post-media">
                    <source src="{{ post.video.url }}" type="video/mp4">
                </video>
            {% endif %}
        </div>

        <!-- Caption -->
        <div class="post-caption">
            <p>{{ post.caption }}</p>
        </div>

        <!-- Reaction Counts -->
        <div class="reaction-counts" data-post-id="{{ post.id }}">
            <span>{{ post.reaction_counts.like|default:0 }} Like(s)</span>
            <span>{{ post.reaction_counts.love|default:0 }} Love(s)</span>
            <span>{{ post.reaction_counts.haha|default:0 }} Haha(s)</span>
            <span>{{ post.reaction_counts.wow|default:0 }} Wow(s)</span>
            <span>{{ post.reaction_counts.cry|default:0 }} Cry(s)</span>
            <span>{{ post.reaction_counts.angry|default:0 }} Angry(s)</span>
            <span>{{ post.reaction_counts.dislike|default:0 }} Dislike(s)</span>
        </div>

        <!-- Reaction Buttons -->
        {% if not request.user.profile.is_banned %}
        <div class="reaction-buttons">
                <a data-post-id="{{ post.id }}" data-reaction-type="like" class="react-btn {% if post.user_reacted_type == 'like' %}active-like{% endif %}" title="Like">
                    <img src="{% static 'icons/like.svg' %}" alt="Like" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="love" class="react-btn {% if post.user_reacted_type == 'love' %}active-love{% endif %}" title="Love">
                    <img src="{% static 'icons/love.svg' %}" alt="Love" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="haha" class="react-btn {% if post.user_reacted_type == 'haha' %}active-haha{% endif %}" title="Haha">
                    <img src="{% static 'icons/laugh.svg' %}" alt="Haha" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="wow" class="react-btn {% if post.user_reacted_type == 'wow' %}active-wow{% endif %}" title="Wow">
                    <img src="{% static 'icons/wow.svg' %}" alt="Wow" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="cry" class="react-btn {% if post.user_reacted_type == 'cry' %}active-cry{% endif %}" title="Cry">
                    <img src="{% static 'icons/cry.svg' %}" alt="Cry" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="angry" class="react-btn {% if post.user_reacted_type == 'angry' %}active-angry{% endif %}" title="Angry">
                    <img src="{% static 'icons/angry.svg' %}" alt="Angry" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="dislike" class="react-btn {% if post.user_reacted_type == 'dislike' %}active-dislike{% endif %}" title="Dislike">
                    <img src="{% static 'icons/dislike.svg' %}" alt="Dislike" class="reaction-icon">
                </a>
                </div>
        {% endif %}

        <!-- Comments -->
        <div class="post-comments">
            <h4>Comments</h4>
            <div id="comment-list-container-{{ post.id }}">
                {% for comment in post.comments.all %}
                    <div class="comment">
                        <p><strong>{{ comment.author.username }}</strong>: {{ comment.text }}</p>
                        {% if request.user == comment.author %}
                            <form method="post" action="{% url 'delete_comment' comment_id=comment.id %}" class="delete-comment-form">
                                {% csrf_token %}
                                <button type="submit">Delete</button>
                            </form>
                        {% endif %}
                        {% if not comment.parent_comment and not request.user.profile.is_banned %}
                            <details>
                                <summary>Reply</summary>
                                <form method="post" action="{% url 'add_comment' post_id=post.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <textarea name="text" placeholder="Reply..." required></textarea>
                                    <button type="submit">Submit Reply</button>
                                </form>
                            </details>
                        {% endif %}
                    </div>

                    {% for reply in comment.replies.all %}
                        <div class="comment reply">
                            <p><strong>{{ reply.author.username }}</strong>: {{ reply.text }} (Reply)</p>
                            {% if request.user == reply.author %}
                                <form method="post" action="{% url 'delete_comment' comment_id=reply.id %}">
                                    {% csrf_token %}
                                    <button type="submit">Delete</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% empty %}
                    <p id="no-comments-{{ post.id }}">No comments yet.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Add Comment -->
        {% if not request.user.profile.is_banned %}
        <form id="add-comment-form-{{ post.id }}" method="post" action="{% url 'add_comment' post_id=post.id %}" class="add-comment-form">
            {% csrf_token %}
            <textarea name="text" placeholder="Add a comment..." required></textarea>
            <button type="submit">Comment</button>
        </form>
        {% endif %}

    </div> <!-- .post -->

</div> <!-- .posts -->
<script>
            document.addEventListener('DOMContentLoaded', () => {
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                const postId = "{{ post.id }}";

                // =================================================================
                // 1. REUSABLE FUNCTION DEFINITIONS
                // =================================================================

                // Reusable function to apply the reaction filter (Correct)
                const applyFilter = (filterType) => {
                    // CRITICAL: Always query the DOM for the *current* list of reaction items
                    const reactionItems = document.querySelectorAll(`#post-reaction-list-${postId} .reaction-item`);
                    reactionItems.forEach(item => {
                        if (filterType === 'all' || item.dataset.reactionType === filterType) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                };

                // Function to re-initialize the filter button listeners (The fix for your issue)
                const initFilterLogic = () => {
                    const filterButtons = document.querySelectorAll('.filter-btn');

                    // Attach click listeners to filter buttons
                    filterButtons.forEach(button => {
                        // Ensure no duplicate listeners are added by recreating the handler
                        const newHandler = (e) => {
                            const filterType = e.target.dataset.reactionType;

                            // Toggle active class for visual feedback
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');

                            // Apply filter using the reusable function
                            applyFilter(filterType);
                        };

                        // For safety, remove any existing listeners before adding the new one
                        // (though a simpler approach of clearing and re-adding is often used)
                        button.replaceWith(button.cloneNode(true));
                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            if (btn.dataset.reactionType === button.dataset.reactionType) {
                                btn.addEventListener('click', newHandler);
                            }
                        });
                    });

                    // Initialize: Set 'All' button to active on load
                    const allButton = document.querySelector('.filter-btn[data-reaction-type="all"]');
                    if (allButton) {
                        allButton.classList.add('active');
                    }
                };


                // Function to attach AJAX delete listener to a form (Required for comment delete)
                const attachDeleteListener = (form) => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();

                        if (!confirm("Are you sure you want to delete this comment?")) {
                            return;
                        }

                        const formData = new FormData(form);

                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove the comment element from the DOM
                                form.closest('div').remove();
                                // UX improvement: Check if comments list is empty
                                const commentsContainer = document.getElementById(`comment-list-container-${postId}`);
                                if (commentsContainer && commentsContainer.children.length === 0) {
                                     commentsContainer.innerHTML = `<p id="no-comments-${postId}">No comments yet.</p>`;
                                }
                            } else {
                                console.error('Error deleting comment:', data.error);
                                alert(`Error deleting comment: ${data.error}.`);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                };


                // =================================================================
                // 2. MAIN LOGIC EXECUTION
                // =================================================================

                // --- Attach delete listener to all existing comment delete forms on load ---
                document.querySelectorAll('.delete-comment-form').forEach(attachDeleteListener);

                // --- Reaction Button Logic (AJAX Call) ---
                document.querySelectorAll('.react-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const reactionType = button.dataset.reactionType;
                        const url = `/posts/react/${postId}/${reactionType}/`;

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 1. Update reaction button colors (omitted for brevity, assume this is correct)
                                document.querySelectorAll('.react-btn').forEach(btn => {
                                    btn.style.backgroundColor = '';
                                });
                                if (data.action === 'added' || data.action === 'updated') {
                                    let color = 'lightblue';
                                    if (reactionType === 'love') color = 'pink';
                                    if (reactionType === 'haha') color = 'yellow';
                                    if (reactionType === 'wow') color = 'orange';
                                    if (reactionType === 'cry') color = 'gray';
                                    if (reactionType === 'angry') color = 'red';
                                    if (reactionType === 'dislike') color = 'black';
                                    button.style.backgroundColor = color;
                                }


                                // 2. Update overall reaction counts (omitted for brevity, assume this is correct)
                                const reactionCountsDiv = document.querySelector('.reaction-counts');
                                if (reactionCountsDiv) {
                                    reactionCountsDiv.innerHTML = `
                                        <span>${data.reaction_counts.like || 0} Like(s)</span>
                                        <span>${data.reaction_counts.love || 0} Love(s)</span>
                                        <span>${data.reaction_counts.haha || 0} Haha(s)</span>
                                        <span>${data.reaction_counts.wow || 0} Wow(s)</span>
                                        <span>${data.reaction_counts.cry || 0} Cry(s)</span>
                                        <span>${data.reaction_counts.angry || 0} Angry(s)</span>
                                        <span>${data.reaction_counts.dislike || 0} Dislike(s)</span>
                                    `;
                                }

                                // 3. Rebuild the expandable reaction list (CRITICAL FIX)
                                const reactionListContainer = document.getElementById(`post-reaction-list-${postId}`);
                                const summaryElement = document.getElementById(`reaction-summary-${postId}`);

                                if (reactionListContainer && data.reactions_list) {
                                    let newReactionListHtml = '';
                                    if (data.reactions_list.length > 0) {
                                        data.reactions_list.forEach(react => {
                                            newReactionListHtml += `
                                                <div class="reaction-item" data-reaction-type="${react.type}">
                                                    <p><strong>${react.user}</strong> reacted with ${react.type}</p>
                                                </div>
                                            `;
                                        });
                                    } else {
                                        newReactionListHtml = '<p>No reactions yet.</p>';
                                    }

                                    reactionListContainer.innerHTML = newReactionListHtml;

                                    summaryElement.innerHTML = `${data.reactions_list.length} total reactions (Click to view)`;

                                    // Reapply the filter to the newly created list elements
                                    const activeFilterButton = document.querySelector('.filter-btn.active');
                                    const currentFilter = activeFilterButton ? activeFilterButton.dataset.reactionType : 'all';
                                    applyFilter(currentFilter);

                                    // *** NEW: Re-initialize all filter button listeners
                                    // This ensures the filter works after the list HTML is replaced
                                    initFilterLogic();
                                }

                            } else {
                                console.error('Failed to submit reaction:', data.error);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });

                // --- Comment Submission Logic (AJAX) ---
                const commentForm = document.getElementById(`add-comment-form-${postId}`);
                if (commentForm) {
                    commentForm.addEventListener('submit', (e) => {
                        e.preventDefault();

                        const form = e.target;
                        const commentTextarea = form.querySelector('textarea[name="text"]');
                        const commentText = commentTextarea.value;

                        if (!commentText.trim()) return;

                        const formData = new URLSearchParams();
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        formData.append('text', commentText);
                        formData.append('parent_id', '');

                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: formData.toString()
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const commentsContainer = document.getElementById(`comment-list-container-${postId}`);

                                if (commentsContainer) {
                                    const noCommentsMsg = document.getElementById(`no-comments-${postId}`);
                                    if (noCommentsMsg) {
                                        noCommentsMsg.remove();
                                    }

                                    const newCommentDiv = document.createElement('div');
                                    newCommentDiv.style.borderTop = '1px dashed #ccc';
                                    newCommentDiv.style.paddingTop = '10px';
                                    newCommentDiv.style.marginTop = '10px';

                                    newCommentDiv.innerHTML = `
                                        <p style="display:inline;"><strong>${data.author_username}</strong>: ${data.comment_text}</p>

                                        <form class="delete-comment-form" method="post" action="/posts/delete_comment/${data.comment_id}/" style="display:inline; margin-left: 10px;">
                                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                            <button type="submit" data-comment-id="${data.comment_id}">Delete</button>
                                        </form>
                                    `;

                                    commentsContainer.appendChild(newCommentDiv);

                                    const newDeleteForm = newCommentDiv.querySelector('.delete-comment-form');
                                    if (newDeleteForm) {
                                        attachDeleteListener(newDeleteForm);
                                    }

                                    commentTextarea.value = '';
                                }

                            } else {
                                console.error('Error adding comment:', data.error);
                                alert(`Error adding comment: ${data.error}.`);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                }

                // --- Filtering Button Initialization (Run once on load) ---
                initFilterLogic();
            });
        </script>

{% endblock %}
