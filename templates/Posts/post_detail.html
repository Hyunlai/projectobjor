{% extends 'base.html' %}

{% block content %}
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h3>
            Post by <a href="{% url 'profile' username=post.author.username %}" style="text-decoration: none; color: inherit;">{{ post.author.username }}</a>
            {% if request.user.is_authenticated and request.user.admin.is_admin and post.author.admin.is_admin %}
                <span style="background-color: #4CAF50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">
                    ADMIN
                </span>
            {% endif %}
        </h3>
        <p><small>Posted on {{ post.created_at|date:"F j, Y, P" }}</small></p>

         {% if post.image %}
            <img src="{{ post.image.url }}" style="max-width: 100%; height: auto;">
        {% elif post.video %}
            <video controls style="max-width: 100%; height: auto;">
                <source src="{{ post.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        {% endif %}
        <p>{{ post.caption }}</p>

        <div class="reaction-counts" data-post-id="{{ post.id }}" style="margin-top: 10px;">
            <span>{{ post.reaction_counts.like|default:0 }} Like(s)</span>
            <span>{{ post.reaction_counts.love|default:0 }} Love(s)</span>
            <span>{{ post.reaction_counts.haha|default:0 }} Haha(s)</span>
            <span>{{ post.reaction_counts.wow|default:0 }} Wow(s)</span>
            <span>{{ post.reaction_counts.cry|default:0 }} Cry(s)</span>
            <span>{{ post.reaction_counts.angry|default:0 }} Angry(s)</span>
            <span>{{ post.reaction_counts.dislike|default:0 }} Dislike(s)</span>
        </div>

        <div style="margin-top: 5px;">
            {% if not request.user.profile.is_banned %}
                <a data-post-id="{{ post.id }}" data-reaction-type="like" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'like' %}lightblue{% endif %};">Like</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="love" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'love' %}pink{% endif %};">Love</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="haha" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'haha' %}yellow{% endif %};">Haha</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="wow" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'wow' %}orange{% endif %};">Wow</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="cry" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'cry' %}gray{% endif %};">Cry</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="angry" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'angry' %}red{% endif %};">Angry</a>
                <a data-post-id="{{ post.id }}" data-reaction-type="dislike" class="react-btn btn btn-primary" style="background-color: {% if post.user_reacted_type == 'dislike' %}black{% endif %};">Dislike</a>
            {% endif %}
        </div>

        <div style="margin-top: 20px;">
            <h4>Reactions</h4>
            <button class="filter-btn" data-reaction-type="all">All</button>
            <button class="filter-btn" data-reaction-type="like">Like</button>
            <button class="filter-btn" data-reaction-type="love">Love</button>
            <button class="filter-btn" data-reaction-type="haha">Haha</button>
            <button class="filter-btn" data-reaction-type="wow">Wow</button>
            <button class="filter-btn" data-reaction-type="cry">Cry</button>
            <button class="filter-btn" data-reaction-type="angry">Angry</button>
            <button class="filter-btn" data-reaction-type="dislike">Dislike</button>

            <details>
                <summary id="reaction-summary-{{ post.id }}">{{ post.reacts.count }} total reactions (Click to view)</summary>
                <div id="post-reaction-list-{{ post.id }}">
                    {% for react in post.reacts.all %}
                    <div class="reaction-item" data-reaction-type="{{ react.type }}">
                        <p>{{ react.user.username }} reacted with {{ react.type }}</p>
                    </div>
                    {% empty %}
                        <p>No reactions yet.</p>
                    {% endfor %}
                </div>
            </details>
        </div>

        <div style="margin-top: 20px;">
            <h4>Comments</h4>
            <div id="comment-list-container-{{ post.id }}">
                {% for comment in post.comments.all %}
                    <div style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                        <p style="display:inline;"><strong>{{ comment.author.username }}</strong>: {{ comment.text }}</p>
                        {% if request.user == comment.author %}
                            <form method="post" action="{% url 'delete_comment' comment_id=comment.id %}" style="display:inline; margin-left: 10px;">
                                {% csrf_token %}
                                <button type="submit">Delete</button>
                            </form>
                        {% endif %}
                        {% if not comment.parent_comment and not request.user.profile.is_banned %}
                            <details style="display:inline; margin-left: 10px;">
                                <summary>Reply</summary>
                                <form method="post" action="{% url 'add_comment' post_id=post.id %}" style="margin-top: 5px;">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <textarea name="text" placeholder="Reply..." required></textarea>
                                    <button type="submit">Submit Reply</button>
                                </form>
                            </details>
                        {% endif %}
                    </div>

                    {% for reply in comment.replies.all %}
                        <div style="margin-left: 20px; border-top: 1px dotted #eee; padding-top: 5px; margin-top: 5px;">
                            <p style="display:inline;"><strong>{{ reply.author.username }}</strong>: {{ reply.text }} (Reply)</p>
                            {% if request.user == reply.author %}
                                <form method="post" action="{% url 'delete_comment' comment_id=reply.id %}" style="display:inline; margin-left: 10px;">
                                    {% csrf_token %}
                                    <button type="submit">Delete</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% empty %}
                    <p id="no-comments-{{ post.id }}">No comments yet.</p>
                {% endfor %}
            </div>
        </div>

        <div style="margin-top: 15px;">
            {% if not request.user.profile.is_banned %}
                <form id="add-comment-form-{{ post.id }}" method="post" action="{% url 'add_comment' post_id=post.id %}">
                    {% csrf_token %}
                    <textarea name="text" placeholder="Add a comment..." required></textarea>
                    <button type="submit">Comment</button>
                </form>
            {% endif %}
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                const postId = "{{ post.id }}";

                // =================================================================
                // 1. REUSABLE FUNCTION DEFINITIONS
                // =================================================================

                // Reusable function to apply the reaction filter (Correct)
                const applyFilter = (filterType) => {
                    // CRITICAL: Always query the DOM for the *current* list of reaction items
                    const reactionItems = document.querySelectorAll(`#post-reaction-list-${postId} .reaction-item`);
                    reactionItems.forEach(item => {
                        if (filterType === 'all' || item.dataset.reactionType === filterType) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                };

                // Function to re-initialize the filter button listeners (The fix for your issue)
                const initFilterLogic = () => {
                    const filterButtons = document.querySelectorAll('.filter-btn');

                    // Attach click listeners to filter buttons
                    filterButtons.forEach(button => {
                        // Ensure no duplicate listeners are added by recreating the handler
                        const newHandler = (e) => {
                            const filterType = e.target.dataset.reactionType;

                            // Toggle active class for visual feedback
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');

                            // Apply filter using the reusable function
                            applyFilter(filterType);
                        };

                        // For safety, remove any existing listeners before adding the new one
                        // (though a simpler approach of clearing and re-adding is often used)
                        button.replaceWith(button.cloneNode(true));
                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            if (btn.dataset.reactionType === button.dataset.reactionType) {
                                btn.addEventListener('click', newHandler);
                            }
                        });
                    });

                    // Initialize: Set 'All' button to active on load
                    const allButton = document.querySelector('.filter-btn[data-reaction-type="all"]');
                    if (allButton) {
                        allButton.classList.add('active');
                    }
                };


                // Function to attach AJAX delete listener to a form (Required for comment delete)
                const attachDeleteListener = (form) => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();

                        if (!confirm("Are you sure you want to delete this comment?")) {
                            return;
                        }

                        const formData = new FormData(form);

                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove the comment element from the DOM
                                form.closest('div').remove();
                                // UX improvement: Check if comments list is empty
                                const commentsContainer = document.getElementById(`comment-list-container-${postId}`);
                                if (commentsContainer && commentsContainer.children.length === 0) {
                                     commentsContainer.innerHTML = `<p id="no-comments-${postId}">No comments yet.</p>`;
                                }
                            } else {
                                console.error('Error deleting comment:', data.error);
                                alert(`Error deleting comment: ${data.error}.`);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                };


                // =================================================================
                // 2. MAIN LOGIC EXECUTION
                // =================================================================

                // --- Attach delete listener to all existing comment delete forms on load ---
                document.querySelectorAll('.delete-comment-form').forEach(attachDeleteListener);

                // --- Reaction Button Logic (AJAX Call) ---
                document.querySelectorAll('.react-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const reactionType = button.dataset.reactionType;
                        const url = `/posts/react/${postId}/${reactionType}/`;

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 1. Update reaction button colors (omitted for brevity, assume this is correct)
                                document.querySelectorAll('.react-btn').forEach(btn => {
                                    btn.style.backgroundColor = '';
                                });
                                if (data.action === 'added' || data.action === 'updated') {
                                    let color = 'lightblue';
                                    if (reactionType === 'love') color = 'pink';
                                    if (reactionType === 'haha') color = 'yellow';
                                    if (reactionType === 'wow') color = 'orange';
                                    if (reactionType === 'cry') color = 'gray';
                                    if (reactionType === 'angry') color = 'red';
                                    if (reactionType === 'dislike') color = 'black';
                                    button.style.backgroundColor = color;
                                }


                                // 2. Update overall reaction counts (omitted for brevity, assume this is correct)
                                const reactionCountsDiv = document.querySelector('.reaction-counts');
                                if (reactionCountsDiv) {
                                    reactionCountsDiv.innerHTML = `
                                        <span>${data.reaction_counts.like || 0} Like(s)</span>
                                        <span>${data.reaction_counts.love || 0} Love(s)</span>
                                        <span>${data.reaction_counts.haha || 0} Haha(s)</span>
                                        <span>${data.reaction_counts.wow || 0} Wow(s)</span>
                                        <span>${data.reaction_counts.cry || 0} Cry(s)</span>
                                        <span>${data.reaction_counts.angry || 0} Angry(s)</span>
                                        <span>${data.reaction_counts.dislike || 0} Dislike(s)</span>
                                    `;
                                }

                                // 3. Rebuild the expandable reaction list (CRITICAL FIX)
                                const reactionListContainer = document.getElementById(`post-reaction-list-${postId}`);
                                const summaryElement = document.getElementById(`reaction-summary-${postId}`);

                                if (reactionListContainer && data.reactions_list) {
                                    let newReactionListHtml = '';
                                    if (data.reactions_list.length > 0) {
                                        data.reactions_list.forEach(react => {
                                            newReactionListHtml += `
                                                <div class="reaction-item" data-reaction-type="${react.type}">
                                                    <p><strong>${react.user}</strong> reacted with ${react.type}</p>
                                                </div>
                                            `;
                                        });
                                    } else {
                                        newReactionListHtml = '<p>No reactions yet.</p>';
                                    }

                                    reactionListContainer.innerHTML = newReactionListHtml;

                                    summaryElement.innerHTML = `${data.reactions_list.length} total reactions (Click to view)`;

                                    // Reapply the filter to the newly created list elements
                                    const activeFilterButton = document.querySelector('.filter-btn.active');
                                    const currentFilter = activeFilterButton ? activeFilterButton.dataset.reactionType : 'all';
                                    applyFilter(currentFilter);

                                    // *** NEW: Re-initialize all filter button listeners
                                    // This ensures the filter works after the list HTML is replaced
                                    initFilterLogic();
                                }

                            } else {
                                console.error('Failed to submit reaction:', data.error);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });

                // --- Comment Submission Logic (AJAX) ---
                const commentForm = document.getElementById(`add-comment-form-${postId}`);
                if (commentForm) {
                    commentForm.addEventListener('submit', (e) => {
                        e.preventDefault();

                        const form = e.target;
                        const commentTextarea = form.querySelector('textarea[name="text"]');
                        const commentText = commentTextarea.value;

                        if (!commentText.trim()) return;

                        const formData = new URLSearchParams();
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        formData.append('text', commentText);
                        formData.append('parent_id', '');

                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: formData.toString()
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const commentsContainer = document.getElementById(`comment-list-container-${postId}`);

                                if (commentsContainer) {
                                    const noCommentsMsg = document.getElementById(`no-comments-${postId}`);
                                    if (noCommentsMsg) {
                                        noCommentsMsg.remove();
                                    }

                                    const newCommentDiv = document.createElement('div');
                                    newCommentDiv.style.borderTop = '1px dashed #ccc';
                                    newCommentDiv.style.paddingTop = '10px';
                                    newCommentDiv.style.marginTop = '10px';

                                    newCommentDiv.innerHTML = `
                                        <p style="display:inline;"><strong>${data.author_username}</strong>: ${data.comment_text}</p>

                                        <form class="delete-comment-form" method="post" action="/posts/delete_comment/${data.comment_id}/" style="display:inline; margin-left: 10px;">
                                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                            <button type="submit" data-comment-id="${data.comment_id}">Delete</button>
                                        </form>
                                    `;

                                    commentsContainer.appendChild(newCommentDiv);

                                    const newDeleteForm = newCommentDiv.querySelector('.delete-comment-form');
                                    if (newDeleteForm) {
                                        attachDeleteListener(newDeleteForm);
                                    }

                                    commentTextarea.value = '';
                                }

                            } else {
                                console.error('Error adding comment:', data.error);
                                alert(`Error adding comment: ${data.error}.`);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                }

                // --- Filtering Button Initialization (Run once on load) ---
                initFilterLogic();
            });
        </script>

{% endblock %}