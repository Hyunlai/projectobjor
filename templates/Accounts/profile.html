{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<!-- Set per-user theme colors -->
<div id="user-theme" style="
    --color-accent: {{ profile.color_accent }};
    --color-accent-light: {{ profile.color_accent_light }};
    --color-accent-dark: {{ profile.color_accent_dark }};
    --bg-main: {{ profile.bg_main }};
    --bg-sidebar: {{ profile.bg_sidebar }};
"></div>
<div class="profile-container">

    <main class="main-profile">
        <!-- Profile Header -->
        <div class="main-profile-header">
            <!-- Banner -->
            {% if user.profile.profile_banner %}
                <img class="profile-banner" src="{{ user.profile.profile_banner.url }}" alt="Profile banner">
            {% else %}
                <div class="profile-banner"></div>
            {% endif %}

            <!-- Profile Picture -->
            {% if user.profile.profile_picture %}
                <img class="profile-pic" src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }}'s profile picture">
            {% else %}
                <img class="profile-pic" src="{% static 'images/default.png' %}" alt="Default profile picture">
            {% endif %}

            <!-- Username -->
            <h1>{{ user.username }}</h1>

            <!-- Follow / Update Button -->
            <div class="profile-actions">
                {% if user != request.user %}
                    {% if is_following %}
                        <form action="{% url 'unfollow_user' username=user.username %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="follow-btn">Unfollow</button>
                        </form>
                    {% else %}
                        <form action="{% url 'follow_user' username=user.username %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="follow-btn">Follow</button>
                        </form>
                    {% endif %}
                {% else %}
                    <a href="{% url 'profile_update' %}" class="update-btn">Update Profile</a>
                {% endif %}
            </div>

            <!-- Stats -->
            <div class="stats">
                Followers: {{ followers_count }} | Following: {{ following_count }}
            </div>
        </div>

        <!-- Bio -->
        <div class="bio">
            {{ user.profile.bio }}
        </div>

        <!-- Posts -->
        <div class="posts">
            {% for post in posts %}
                <div class="post">
                    {% if post.original_post %}
                        <!-- Shared Post -->
                        <div class="shared-post">
                            <p>Shared from <a href="{% url 'profile' username=post.original_post.author.username %}">{{ post.original_post.author.username }}'s</a> post:</p>

                            {% if post.original_post.image %}
                                <img src="{{ post.original_post.image.url }}" alt="Shared post image">
                            {% elif post.original_post.video %}
                                <video controls>
                                    <source src="{{ post.original_post.video.url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% endif %}

                            <p>{{ post.original_post.caption }}</p>

                            <div class="reaction-buttons">
                                <a href="{% url 'add_reaction' post.original_post.id 'like' %}" class="reaction-btn">Like</a>
                                <a href="{% url 'add_reaction' post.original_post.id 'love' %}" class="reaction-btn">Love</a>
                                <a href="{% url 'add_reaction' post.original_post.id 'haha' %}" class="reaction-btn">Haha</a>
                                <a href="{% url 'add_reaction' post.original_post.id 'wow' %}" class="reaction-btn">Wow</a>
                                <a href="{% url 'add_reaction' post.original_post.id 'cry' %}" class="reaction-btn">Cry</a>
                                <a href="{% url 'add_reaction' post.original_post.id 'dislike' %}" class="reaction-btn">Dislike</a>
                            </div>

                            <p><small>Posted on {{ post.original_post.created_at|date:"F j, Y, P" }}</small></p>
                        </div>
                    {% else %}
                        <!-- Normal Post -->
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="Post image">
                        {% elif post.video %}
                            <video controls>
                                <source src="{{ post.video.url }}" type="video/mp4">
                            </video>
                        {% endif %}

                        <p>{{ post.caption }}</p>

                        <div class="reaction-buttons">
                            <a href="{% url 'add_reaction' post.id 'like' %}" class="reaction-btn">Like</a>
                            <a href="{% url 'add_reaction' post.id 'love' %}" class="reaction-btn">Love</a>
                            <a href="{% url 'add_reaction' post.id 'haha' %}" class="reaction-btn">Haha</a>
                            <a href="{% url 'add_reaction' post.id 'wow' %}" class="reaction-btn">Wow</a>
                            <a href="{% url 'add_reaction' post.id 'cry' %}" class="reaction-btn">Cry</a>
                            <a href="{% url 'add_reaction' post.id 'dislike' %}" class="reaction-btn">Dislike</a>
                        </div>

                        <p><small>Posted on {{ post.created_at|date:"F j, Y, P" }}</small></p>
                    {% endif %}

                    <!-- Share Post Button -->
                    <a href="{% url 'share_post' post.id %}">Share</a>

                    <!-- Reactions List -->
                    <div style="margin-top: 15px;">
                        <details>
                            <summary><h4>View Reactions</h4></summary>
                            {% for reaction in post.react_set.all %}
                                <p style="margin: 0;">{{ reaction.user.username }} reacted with "{{ reaction.type }}"</p>
                            {% endfor %}
                        </details>
                    </div>
                </div>
            {% empty %}
                <p>{{ user.username }} has not created any posts yet.</p>
            {% endfor %}
        </div>

    </main>
</div>
{% endblock %}
