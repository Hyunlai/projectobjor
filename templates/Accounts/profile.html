{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/post.css' %}">
{% endblock %}

{% block content %}
<!-- Set per-user theme colors -->
<div id="user-theme" style="
    --color-accent: {{ profile.color_accent }};
    --color-accent-light: {{ profile.color_accent_light }};
    --color-accent-dark: {{ profile.color_accent_dark }};
    --bg-main: {{ profile.bg_main }};
    --bg-sidebar: {{ profile.bg_sidebar }};
"></div>

<div class="profile-container">
    <main class="main-profile">

        <!-- Profile Header -->
        <div class="main-profile-header">

            <!-- Floating Song Widget -->
            <div class="floating-song-widget">
                {% if profile.profile_song %}
                    {% with profile.profile_song.name|cut:"profile_song/" as filename %}
                        <p class="song-name">{{ filename|cut:".mp3"|cut:".wav"|cut:".ogg" }}</p>
                    {% endwith %}
                    <audio id="profileAudio" autoplay>
                        <source src="{{ profile.profile_song.url }}" type="audio/mpeg">
                    </audio>
                {% else %}
                    <p class="song-name">Default Song</p>
                    <audio id="profileAudio" autoplay>
                        <source src="{% static 'audio/song.mp3' %}" type="audio/mpeg">
                    </audio>
                {% endif %}
                <input type="range" id="volumeControl" min="0" max="100" value="40">
            </div>

            <script>
            document.addEventListener("DOMContentLoaded", function() {
                const audio = document.getElementById("profileAudio");
                const volumeSlider = document.getElementById("volumeControl");
                if (!audio) return;
                audio.volume = volumeSlider.value / 100;
                volumeSlider.addEventListener("input", () => { audio.volume = volumeSlider.value / 100; });
            });
            </script>

            <!-- Banner -->
            {% if user.profile.profile_banner %}
                <img class="profile-banner" src="{{ user.profile.profile_banner.url }}" alt="Profile banner">
            {% else %}
                <div class="profile-banner"></div>
            {% endif %}

            <!-- Profile Picture -->
            {% if user.profile.profile_picture %}
                <img class="profile-pic" src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }}'s profile picture">
            {% else %}
                <img class="profile-pic" src="{% static 'images/default.png' %}" alt="Default profile picture">
            {% endif %}

            <!-- Username -->
            <h1>{{ user.username }}</h1>

            <!-- Follow / Update Button -->
            <div class="profile-actions">
                {% if user != request.user %}
                    {% if is_following %}
                        <form action="{% url 'unfollow_user' username=user.username %}" method="post">{% csrf_token %}
                            <button type="submit" class="follow-btn">Unfollow</button>
                        </form>
                    {% else %}
                        <form action="{% url 'follow_user' username=user.username %}" method="post">{% csrf_token %}
                            <button type="submit" class="follow-btn">Follow</button>
                        </form>
                    {% endif %}
                {% else %}
                    <a href="{% url 'profile_update' %}" class="update-btn">Update Profile</a>
                {% endif %}
            </div>

            <!-- Stats -->
            <div class="stats">
                Followers: {{ followers_count }} | Following: {{ following_count }}
            </div>
        </div>

        <!-- Bio -->
        <div class="bio">
            {{ user.profile.bio }}
        </div>

        <!-- Posts -->
        <div class="posts">
        {% if posts %}
            {% for post in posts %}
                <div class="post-container">
                    <div class="post-header">
                        <a href="{% url 'profile' username=post.author.username %}" class="author-link">
                            {% if post.author.profile.profile_picture %}
                                <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}'s profile picture" class="author-image">
                            {% else %}
                                <img src="{% static 'images/default.png' %}" alt="Default profile picture" class="author-image">
                            {% endif %}
                        </a>
                        <p class="post-meta">
                            Posted by <a href="{% url 'profile' username=post.author.username %}">{{ post.author.username }}</a>
                            on {{ post.created_at|date:"F j, Y, P" }}
                        </p>
                    </div>

                    {% if post.original_post %}
                        <p class="shared-from">
                            Shared from <a href="{% url 'profile' username=post.original_post.author.username %}">{{ post.original_post.author.username }}'s</a> post.
                        </p>
                    {% endif %}

                    <a href="{% url 'post_detail' post_id=post.id %}" class="post-link">
                        {% if post.image %}
                            <img src="{{ post.image.url }}" class="post-media">
                        {% elif post.video %}
                            <video controls class="post-media">
                                <source src="{{ post.video.url }}" type="video/mp4">
                            </video>
                        {% endif %}
                        <p class="post-caption">{{ post.caption }}</p>
                    </a>

                    {% if not request.user.profile.is_banned %}
                        {% if request.user == post.author %}
                            <form method="post" action="{% url 'delete_post' post_id=post.id %}" class="inline-form">{% csrf_token %}
                                <button type="submit" class="delete-btn">Delete Post</button>
                            </form>
                        {% endif %}
                        <a href="{% url 'share_post' post.id %}" class="share-link">Share</a>

                        <div class="reaction-counts" data-post-id="{{ post.id }}">
                            <span>{{ post.reaction_counts.like|default:0 }} Like(s)</span>
                            <span>{{ post.reaction_counts.love|default:0 }} Love(s)</span>
                            <span>{{ post.reaction_counts.haha|default:0 }} Haha(s)</span>
                            <span>{{ post.reaction_counts.wow|default:0 }} Wow(s)</span>
                            <span>{{ post.reaction_counts.cry|default:0 }} Cry(s)</span>
                            <span>{{ post.reaction_counts.angry|default:0 }} Angry(s)</span>
                            <span>{{ post.reaction_counts.dislike|default:0 }} Dislike(s)</span>
                        </div>

                        <div class="reaction-buttons">
                <a data-post-id="{{ post.id }}" data-reaction-type="like" class="react-btn {% if post.user_reacted_type == 'like' %}active-like{% endif %}" title="Like">
                    <img src="{% static 'icons/like.svg' %}" alt="Like" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="love" class="react-btn {% if post.user_reacted_type == 'love' %}active-love{% endif %}" title="Love">
                    <img src="{% static 'icons/love.svg' %}" alt="Love" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="haha" class="react-btn {% if post.user_reacted_type == 'haha' %}active-haha{% endif %}" title="Haha">
                    <img src="{% static 'icons/laugh.svg' %}" alt="Haha" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="wow" class="react-btn {% if post.user_reacted_type == 'wow' %}active-wow{% endif %}" title="Wow">
                    <img src="{% static 'icons/wow.svg' %}" alt="Wow" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="cry" class="react-btn {% if post.user_reacted_type == 'cry' %}active-cry{% endif %}" title="Cry">
                    <img src="{% static 'icons/cry.svg' %}" alt="Cry" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="angry" class="react-btn {% if post.user_reacted_type == 'angry' %}active-angry{% endif %}" title="Angry">
                    <img src="{% static 'icons/angry.svg' %}" alt="Angry" class="reaction-icon">
                </a>

                <a data-post-id="{{ post.id }}" data-reaction-type="dislike" class="react-btn {% if post.user_reacted_type == 'dislike' %}active-dislike{% endif %}" title="Dislike">
                    <img src="{% static 'icons/dislike.svg' %}" alt="Dislike" class="reaction-icon">
                </a>
                </div>

                        <!-- Comments -->
                        <div class="comments-section">
                            <h4>Latest Comment</h4>
                            <div id="latest-comment-{{ post.id }}" class="latest-comment">
                                {% with latest_comment=post.comments.all|dictsort:"created_at"|last %}
                                    {% if latest_comment %}
                                        <div class="comment-item">
                                            <p><strong>{{ latest_comment.author.username }}</strong>: {{ latest_comment.text }}</p>
                                            {% if request.user == latest_comment.author %}
                                                <form method="post" action="{% url 'delete_comment' comment_id=latest_comment.id %}" class="inline-form">{% csrf_token %}
                                                    <button type="submit" class="delete-btn small">Delete</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <p class="no-comments">No comments yet.</p>
                                    {% endif %}
                                {% endwith %}
                            </div>

                            <form method="post" action="{% url 'add_comment' post_id=post.id %}" class="add-comment-form">{% csrf_token %}
                                <textarea name="text" placeholder="Add a comment..." required></textarea>
                                <button type="submit" class="comment-btn">Comment</button>
                            </form>
                        </div>

                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>{{ user.username }} has not created any posts yet.</p>
        {% endif %}
        </div>

    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        document.querySelectorAll('.react-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const postId = button.dataset.postId;
                const reactionType = button.dataset.reactionType;
                const url = `/posts/react/${postId}/${reactionType}/`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelectorAll('.react-btn[data-post-id="' + postId + '"]').forEach(btn => {
                            btn.style.backgroundColor = '';
                        });
                        if (data.action === 'added') {
                            button.style.backgroundColor = 'lightblue';
                        }
                        const reactionCountsDiv = document.querySelector('.reaction-counts[data-post-id="' + postId + '"]');
                        if (reactionCountsDiv) {
                            reactionCountsDiv.innerHTML = `
                                <span>${data.reaction_counts.like || 0} Like(s)</span>
                                <span>${data.reaction_counts.love || 0} Love(s)</span>
                                <span>${data.reaction_counts.haha || 0} Haha(s)</span>
                                <span>${data.reaction_counts.wow || 0} Wow(s)</span>
                                <span>${data.reaction_counts.cry || 0} Cry(s)</span>
                                <span>${data.reaction_counts.angry || 0} Angry(s)</span>
                                <span>${data.reaction_counts.dislike || 0} Dislike(s)</span>
                            `;
                        }
                    } else {
                        console.error('Failed to submit reaction:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        document.querySelectorAll('.add-comment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const postId = this.action.split('/').slice(-2)[0];
                const commentText = this.querySelector('textarea[name="text"]').value;
                const url = this.action;
                const body = `text=${encodeURIComponent(commentText)}&parent_id=&post_id=${postId}&csrfmiddlewaretoken=${csrfToken}`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: body
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const commentsContainer = document.getElementById(`latest-comment-${postId}`);
                        const noCommentsMsg = commentsContainer.querySelector('p');
                        if (noCommentsMsg && noCommentsMsg.textContent.trim() === 'No comments yet.') {
                            noCommentsMsg.remove();
                        }
                        const newCommentDiv = document.createElement('div');
                        newCommentDiv.style.borderTop = '1px dashed #ccc';
                        newCommentDiv.style.paddingTop = '10px';
                        newCommentDiv.style.marginTop = '10px';
                        newCommentDiv.innerHTML = `<p style="display:inline;"><strong>${data.author_username}</strong>: ${data.comment_text}</p>`;
                        commentsContainer.appendChild(newCommentDiv);
                        this.querySelector('textarea[name="text"]').value = '';
                    } else {
                        console.error('Error adding comment:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
{% endblock %}